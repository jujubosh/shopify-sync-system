name: Inventory Sync - Botanical Interests

on:
  schedule:
    # Run inventory sync every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Force run even if disabled in config'
        required: false
        type: boolean
        default: false

jobs:
  inventory-sync-botanical-interests:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Create logs directory
      run: mkdir -p logs
      
    - name: Check if inventory sync is enabled
      id: check-config
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      run: |
        if [ "${{ github.event.inputs.force_run }}" = "true" ]; then
          echo "force_run=true" >> $GITHUB_OUTPUT
          echo "enabled=true" >> $GITHUB_OUTPUT
          echo "Inventory sync forced to run"
        else
          # Check if inventory sync is enabled in database
          ENABLED=$(node -e "
            const { RetailerService } = require('./scripts/utils/retailer-service');
            
            async function checkInventorySync() {
              try {
                const retailerService = new RetailerService();
                const retailer = await retailerService.loadRetailerById('botanical-interests');
                if (retailer.settings && retailer.settings.syncInventory) {
                  console.log('true');
                } else {
                  console.log('false');
                }
              } catch (error) {
                console.error('Error checking database:', error.message);
                console.log('false');
              }
            }
            
            checkInventorySync();
          ")
          echo "enabled=$ENABLED" >> $GITHUB_OUTPUT
          if [ "$ENABLED" = "true" ]; then
            echo "Inventory sync is enabled for Botanical Interests (from database)"
          else
            echo "Inventory sync is disabled for Botanical Interests (from database)"
          fi
        fi
      
    - name: Run Botanical Interests Inventory Sync
      if: steps.check-config.outputs.force_run == 'true' || steps.check-config.outputs.enabled == 'true'
      env:
        MAILGUN_API_KEY: ${{ secrets.MAILGUN_API_KEY }}
        MAILGUN_DOMAIN: ${{ secrets.MAILGUN_DOMAIN }}
        SHOPIFY_LGL_TOKEN: ${{ secrets.SHOPIFY_LGL_TOKEN }}
        SHOPIFY_BOTANICALINTERESTS_TOKEN: ${{ secrets.SHOPIFY_BOTANICALINTERESTS_TOKEN }}
        EMAIL_FROM: admin@livegoodlogistics.com
        EMAIL_TO: justin@livegoodlogistics.com
        LOG_LEVEL: info
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      run: |
        echo "Running Botanical Interests inventory sync"
        node inventory-sync/retailers/botanical-interests.js
        
    - name: Skip sync (disabled in database)
      if: steps.check-config.outputs.force_run != 'true' && steps.check-config.outputs.enabled != 'true'
      run: |
        echo "Skipping Botanical Interests inventory sync - disabled in database"
        echo "To force run, use the workflow_dispatch with force_run=true"
        echo "To enable, update the sync_inventory field in the database for botanical-interests"
        
    - name: Upload logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: inventory-sync-botanical-interests-logs-${{ github.run_id }}
        path: logs/inventory-sync-botanical-interests-*.log
        retention-days: 7 